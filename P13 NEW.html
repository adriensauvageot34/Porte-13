from pathlib import Path

html = r'''<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üß≠ PORTE P13 ‚Äî Espace (reverb / delay / profondeur)</title>

  <style>
    /* ---------------------------------------------
       OPTIONAL "WOW" (local assets)
       - Place a font in ./assets/Inter.var.woff2 (optional)
       - Everything still works without it (fallback system font)
    ----------------------------------------------*/
    @font-face{
      font-family:"InterVar";
      src:url("./assets/Inter.var.woff2") format("woff2");
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg:#0f1115;
      --panel:#151923;
      --card:#171c27;
      --text:#e9ecf2;
      --muted:#aab2c0;
      --line:#2a3244;

      /* Palette ‚Äúfonctionnelle‚Äù */
      --c-state:#6fa6b6;     /* bleu-gris / teal doux */
      --c-path:#b08cff;      /* violet doux */
      --c-target:#66d3ff;    /* cyan doux */
      --c-core:#4aa3ff;      /* bleu net */
      --c-test:#69d38b;      /* vert doux */
      --c-fail:#ff9a58;      /* orange doux */
      --c-tech:#8d92a3;      /* gris-violet */
      --c-bus:#9aa1b0;       /* gris neutre */
      --c-ref:#b9c2d3;       /* gris ref */

      --radius:14px;
      --pad:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: InterVar, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --runbar-h: 62px;
    }

    html{ scroll-behavior:smooth; }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#0e1016 0%, #0f1115 50%, #0b0d12 100%);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
      padding-bottom: calc(var(--runbar-h) + 18px); /* room for runbar */
    }

    /* Subtle "noise" overlay (no asset needed) */
    .noise{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.065;
      mix-blend-mode: overlay;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.09) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 70%, rgba(255,255,255,.08) 0 1px, transparent 2px),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,.07) 0 1px, transparent 2px);
      background-size: 80px 80px, 110px 110px, 140px 140px;
      filter: blur(.35px);
    }

    /* Layout type ‚ÄúWord + Navigation‚Äù */
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px;
      max-width: 1380px;
      margin:0 auto;
    }
    aside{
      position:sticky;
      top:18px;
      align-self:start;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      height: calc(100vh - 36px);
      overflow:auto;
    }
    .nav-title{
      font-weight:800;
      margin:2px 0 10px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .nav-sub{
      color:var(--muted);
      font-size:12px;
      margin:0 0 12px;
    }

    .nav a{
      display:block;
      padding:8px 10px;
      margin:4px 0;
      border-radius:10px;
      color:var(--text);
      text-decoration:none;
      border:1px solid transparent;
      background:rgba(255,255,255,.02);
      outline:none;
    }
    .nav a:hover{
      border-color:rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .nav a.is-current{
      border-color:rgba(127,195,255,.35);
      background:rgba(127,195,255,.08);
      box-shadow: 0 0 0 1px rgba(127,195,255,.12) inset;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      margin-left:8px;
      color:#0d1016;
      font-weight:800;
      vertical-align:middle;
      letter-spacing:.15px;
    }
    .pill svg{ width:14px; height:14px; opacity:.95; }
    .pill.state{background:var(--c-state)}
    .pill.path{background:var(--c-path)}
    .pill.target{background:var(--c-target)}
    .pill.core{background:var(--c-core)}
    .pill.test{background:var(--c-test)}
    .pill.fail{background:var(--c-fail)}
    .pill.tech{background:var(--c-tech)}
    .pill.bus{background:var(--c-bus)}
    .pill.doc{background:#c9d0de}

    .nav-tools{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .mini-btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      font-size:12px;
      cursor:pointer;
    }
    .mini-btn:hover{ background:rgba(255,255,255,.06); }

    main{min-width:0}

    /* Cartes */
    .door-title{
      background:linear-gradient(90deg, rgba(74,163,255,.18), rgba(176,140,255,.12));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .door-title::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 240px at 20% 0%, rgba(102,211,255,.14), transparent 60%),
                  radial-gradient(560px 220px at 80% 40%, rgba(176,140,255,.14), transparent 60%);
      pointer-events:none;
    }
    .door-title h1{
      margin:0 0 6px;
      font-size:20px;
      letter-spacing:.2px;
      position:relative;
      z-index:1;
    }
    .door-title .meta{
      color:var(--muted);
      font-size:13px;
      position:relative;
      z-index:1;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin:14px 0;
      overflow:hidden;
    }
    .card > header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px var(--pad);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .card > header .h{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .tag{
      font-family:var(--mono);
      font-weight:900;
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .tag svg{ width:14px; height:14px; opacity:.9; }
    .sub{
      color:var(--muted);
      font-size:12px;
    }
    .card .body{ padding: var(--pad); }

    /* Bordure gauche couleur par type */
    .state{ border-left:6px solid var(--c-state) }
    .path{ border-left:6px solid var(--c-path) }
    .target{ border-left:6px solid var(--c-target) }
    .core{ border-left:6px solid var(--c-core) }
    .test{ border-left:6px solid var(--c-test) }
    .fail{ border-left:6px solid var(--c-fail) }
    .tech{ border-left:6px solid var(--c-tech) }
    .bus{ border-left:6px solid var(--c-bus) }

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.12);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
      font-size:13px;
    }
    th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.3px;
      background:rgba(255,255,255,.03);
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:nth-child(even) td{ background:rgba(255,255,255,.02) }
    tr:last-child td{ border-bottom:none }
    td.center, th.center{ text-align:center; width:98px; }
    td.small, th.small{ width:200px; }

    /* Active row highlight */
    tr.is-active td{
      background: rgba(127,195,255,.08) !important;
      box-shadow: inset 4px 0 0 rgba(127,195,255,.55);
    }
    tr.is-active.path-row td{ box-shadow: inset 4px 0 0 rgba(176,140,255,.70); }
    tr.is-active.target-row td{ box-shadow: inset 4px 0 0 rgba(102,211,255,.70); }
    tr.is-attn td{
      outline: 2px solid rgba(255,154,88,.55);
      outline-offset: -2px;
      animation: pulse 1.2s ease 0s 2;
    }
    @keyframes pulse{
      0%,100%{ filter:none; }
      50%{ filter: brightness(1.12); }
    }

    /* Inputs */
    input[type="checkbox"], input[type="radio"]{
      width:16px;
      height:16px;
      accent-color: var(--c-core);
      cursor:pointer;
      vertical-align:middle;
    }
    label.opt{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-right:12px;
      user-select:none;
    }

    .fill{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .fill::placeholder{ color:rgba(233,236,242,.45) }

    /* Liens */
    a{ color:#7fc3ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .ref{
      color:var(--c-ref);
      text-decoration:underline;
      text-decoration-color:rgba(185,194,211,.55);
      font-family:var(--mono);
      font-size:12px;
      padding:0 4px;
      border-radius:6px;
      background:rgba(185,194,211,.08);
      border:1px solid rgba(185,194,211,.14);
      white-space:nowrap;
    }

    /* Blocs ‚ÄúSTOP‚Äù */
    .stop{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,154,88,.18);
      background:rgba(255,154,88,.08);
      margin:8px 0;
    }
    .stop b{ color:#ffd1b1; }

    /* Details (Titre 4 ‚Äúrepli√©‚Äù) */
    details.card{ padding:0; }
    details.card > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding:12px var(--pad);
      font-weight:950;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    details.card > summary::-webkit-details-marker{ display:none; }
    details.card > summary .sum-left{
      display:flex; align-items:center; gap:10px;
    }
    details.card > summary .chev{
      width:18px; height:18px;
      transition: transform .18s ease;
      opacity:.9;
    }
    details.card[open] > summary{ background:rgba(255,255,255,.03); }
    details.card[open] > summary .chev{ transform: rotate(90deg); }

    /* Smooth-ish open/close using max-height */
    details.card .body{
      overflow:hidden;
      max-height:0;
      transition: max-height .22s ease;
    }
    details.card[open] .body{
      max-height: 5000px;
    }

    /* Listes */
    ul{ margin:8px 0 0 18px; }
    li{ margin:4px 0; color:var(--text); }
    .muted{ color:var(--muted); }
    .hr{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }

    /* RUN BAR */
    .runbar{
      position:fixed;
      left:50%;
      bottom:12px;
      transform:translateX(-50%);
      width:min(1180px, calc(100% - 24px));
      height: var(--runbar-h);
      background: rgba(21,25,35,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      z-index: 9998;
    }
    .run-left, .run-right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:hover{ background:rgba(255,255,255,.07); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn.primary{
      border-color: rgba(74,163,255,.32);
      background: rgba(74,163,255,.14);
    }
    .btn.warn{
      border-color: rgba(255,154,88,.35);
      background: rgba(255,154,88,.14);
    }
    .btn.ghost{
      background:transparent;
    }
    .btn svg{ width:18px; height:18px; }

    .progress{
      min-width: 280px;
      max-width: 420px;
      width: 35vw;
    }
    .progress-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: rgba(105,211,139,.85);
      transition: width .18s ease;
    }
    .bar.is-fail > div{ background: rgba(255,154,88,.95); }

    /* Density */
    body[data-density="compact"]{
      --pad: 10px;
    }
    body[data-density="compact"] th, body[data-density="compact"] td{ padding:8px 8px; }
    body[data-density="compact"] .door-title{ padding:14px; }
    body[data-density="compact"] .btn{ padding:9px 10px; border-radius:11px; }
    body[data-density="compact"] .runbar{ height:56px; }
    body[data-density="compact"]{ padding-bottom: calc(56px + 18px); }

    /* Command palette */
    .palette-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding-top: 12vh;
      z-index: 10000;
    }
    .palette{
      width: min(720px, calc(100% - 24px));
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(21,25,35,.96);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .palette-head{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .palette-head input{
      width:100%;
      padding: 10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline:none;
    }
    .palette-list{
      max-height: 320px;
      overflow:auto;
      padding: 8px;
    }
    .cmd{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .cmd:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.10);
    }
    .cmd .k{ color: var(--muted); font-size:12px; }

    /* Tiny animations */
    @keyframes shake{
      0%,100%{ transform:translateX(-50%) translateY(0); }
      20%{ transform:translateX(-50%) translateY(0) translateX(-4px); }
      40%{ transform:translateX(-50%) translateY(0) translateX(4px); }
      60%{ transform:translateX(-50%) translateY(0) translateX(-3px); }
      80%{ transform:translateX(-50%) translateY(0) translateX(3px); }
    }
    .runbar.shake{ animation: shake .28s ease; }

    /* Tooltip */
    .tip{
      position:fixed;
      z-index: 9999;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(20,20,24,.96);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 45px rgba(0,0,0,.45);
      color: #fff;
      font-size: 12px;
      max-width: 360px;
      opacity:0;
      transform: translateY(6px);
      transition: .12s ease;
      pointer-events:none;
    }
    .tip.show{ opacity:1; transform: translateY(0); }

    /* Impression */
    @media print{
      body{ background:#fff; color:#000; padding-bottom:0; }
      aside,.runbar,.noise,.palette-backdrop{ display:none !important; }
      .app{ grid-template-columns:1fr; padding:0; }
      .card, .door-title{ box-shadow:none; border-color:#ddd; }
      .ref{ color:#444; background:transparent; border-color:#ddd; }
    }
  </style>
</head>

<body data-density="comfy">
  <!-- Inline SVG sprite (no external file needed) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute; width:0; height:0; overflow:hidden">
    <symbol id="i-chevron" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 18L15 12L9 6v12z"/>
    </symbol>
    <symbol id="i-compass" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm3.5 6.5-2.1 6.9-6.9 2.1 2.1-6.9 6.9-2.1Zm-7.2 7.2 4.3-1.3 1.3-4.3-4.3 1.3-1.3 4.3Z"/>
    </symbol>
    <symbol id="i-check" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
    </symbol>
    <symbol id="i-warn" viewBox="0 0 24 24">
      <path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z"/>
    </symbol>
    <symbol id="i-search" viewBox="0 0 24 24">
      <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.47 6.47 0 0 0 4.23-1.57l.27.28v.79L20 21.5 21.5 20 15.5 14zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </symbol>
    <symbol id="i-gear" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 9.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Z"/>
      <path fill="currentColor" d="M4.5 13.5v-3l2.1-.7a6 6 0 0 1 1.1-2.1L7 5l3-1.5 1.2 2a6 6 0 0 1 2.6 0l1.2-2L18 5l-.7 2.7a6 6 0 0 1 1.1 2.1l2.1.7v3l-2.1.7a6 6 0 0 1-1.1 2.1L18 19l-3 1.5-1.2-2a6 6 0 0 1-2.6 0l-1.2 2L7 19l.7-2.7a6 6 0 0 1-1.1-2.1Z"/>
    </symbol>
    <symbol id="i-next" viewBox="0 0 24 24">
      <path fill="currentColor" d="M8 5v14l11-7L8 5z"/>
    </symbol>
    <symbol id="i-density" viewBox="0 0 24 24">
      <path fill="currentColor" d="M4 7h16v2H4V7zm0 4h16v2H4v-2zm0 4h10v2H4v-2z"/>
    </symbol>
  </svg>

  <div class="noise"></div>

  <div class="app">

    <!-- NAV ‚ÄúWord‚Äù -->
    <aside>
      <div class="nav-title">
        <span>Navigation</span>
        <div class="nav-tools">
          <button class="mini-btn" id="btn_open_palette" title="Ctrl+K">Ctrl+K</button>
          <button class="mini-btn" id="btn_density" title="Comfy / Compact"><svg style="width:16px;height:16px;vertical-align:-3px"><use href="#i-density"/></svg></button>
        </div>
      </div>
      <div class="nav-sub">Titres simul√©s (Titre 2/3/4). Clique pour sauter.</div>

      <div class="nav" id="nav">
        <a href="#p13" data-nav="p13">üß≠ PORTE P13 ‚Äî Espace <span class="pill core"><svg><use href="#i-compass"/></svg>T2</span></a>

        <a href="#state" data-nav="state">0) [STATE] ‚Äî Bandeau d‚Äô√©tat <span class="pill state">T3</span></a>
        <a href="#workflow" data-nav="workflow">0bis) GUIDE FLUX <span class="pill tech">T2</span></a>
        <a href="#path" data-nav="path">1) PATH PICKER <span class="pill path">T3</span></a>
        <a href="#target" data-nav="target">1bis) TARGET PICKER <span class="pill target">T3</span></a>
        <a href="#core" data-nav="core">[CORE] ‚Äî Ex√©cution <span class="pill core">T3</span></a>
        <a href="#tests" data-nav="tests">2) [TEST:ALWAYS] <span class="pill test">T3</span></a>
        <a href="#handoff" data-nav="handoff">12) HANDOFF <span class="pill core">T3</span></a>

        <div class="hr"></div>

        <a href="#redflags" data-nav="redflags">3) [IF:FAIL] RED FLAGS <span class="pill fail">T4</span></a>
        <a href="#sigfail" data-nav="sigfail">4) SYMPT√îMES SIGNATURE <span class="pill fail">T4</span></a>
        <a href="#soclefail" data-nav="soclefail">5) SYMPT√îMES SOCLE <span class="pill fail">T4</span></a>
        <a href="#listen" data-nav="listen">6) LISTEN PANELS <span class="pill tech">T4</span></a>
        <a href="#techpack" data-nav="techpack">7) TECH PACK <span class="pill tech">T4</span></a>
        <a href="#busmap" data-nav="busmap">8) [BUSMAP:P13] <span class="pill bus">T4</span></a>
        <a href="#depends" data-nav="depends">10) ‚ö† DEPENDS / REOPENS <span class="pill tech">T4</span></a>
        <a href="#checkpoints" data-nav="checkpoints">11) CHECKPOINTS <span class="pill tech">T4</span></a>
        <a href="#notes" data-nav="notes">13) NOTES ‚Äî Porte <span class="pill tech">T4</span></a>
        <a href="#journal" data-nav="journal">14) JOURNAL <span class="pill tech">T4</span></a>

        <div class="hr"></div>

        <a href="#r3" data-nav="r3">[REF] R3 (ancres) <span class="pill doc">DOC</span></a>
      </div>
    </aside>

    <!-- CONTENU -->
    <main id="p13">
      <div class="door-title">
        <h1>üß≠ PORTE P13 ‚Äî Espace (reverb / delay / profondeur)</h1>
        <div class="meta">Mockup ‚Äúapp-like‚Äù : cartes, tables cochables, sections repliables (‚âÉ Titre 4 Word). ‚Äî <b>Tout est sauvegard√© automatiquement</b> (localStorage).</div>
      </div>

      <!-- 0bis) GUIDE RAPIDE -->
      <section class="card tech" id="workflow" data-section>
        <header>
          <div class="h">
            <span class="tag"><svg><use href="#i-gear"/></svg>0bis) GUIDE RAPIDE</span>
            <span>Ne pas se perdre dans la porte</span>
          </div>
          <div class="sub">Micro-checklist pour s√©curiser tes √©tapes</div>
        </header>
        <div class="body">
          <ul>
            <li><b>Commence par verrouiller PATH/TARGET</b> : choisis un chemin primaire dans <a href="#path">PATH PICKER</a> puis le couple primaire/secondaire dans <a href="#target">TARGET PICKER</a> avant d‚Äôouvrir d‚Äôautres blocs.</li>
            <li><b>Utilise les √©tats bloquants</b> : passe par le bloc <a href="#tests">[TEST:ALWAYS]</a> pour cocher les tests obligatoires ; la barre de progression et le bouton <i>Done</i> se mettent √† jour automatiquement.</li>
            <li><b>Active les toggles ‚ÄúSTOP‚Äù si doute</b> : bascule <code>[TOGGLE:SIG_OFF]</code> ou <code>[TOGGLE:CTRL_OFF]</code> dans <a href="#state">STATE</a> avant de modifier des √©coutes pour √©viter un run incoh√©rent.</li>
            <li><b>Raccourcis et navigation</b> : Ctrl+K ouvre la palette de commandes, et la navigation lat√©rale suit ton scroll (highlight auto) pour revenir vite aux sections critiques.</li>
            <li><b>Prends des notes rapides</b> : journalise les essais dans <a href="#journal">JOURNAL</a> ; tout est auto-sauvegard√© (localStorage) pour ne pas reperdre le contexte.</li>
          </ul>
        </div>
      </section>

      <!-- 0) STATE -->
      <section class="card state" id="state" data-section>
        <header>
          <div class="h">
            <span class="tag"><svg><use href="#i-compass"/></svg>0) [STATE]</span>
            <span>Bandeau d‚Äô√©tat</span>
          </div>
          <div class="sub">Table (cases + liens rapides)</div>
        </header>

        <div class="body">
          <table>
            <tr>
              <th style="width:220px;">Champ</th>
              <th>Valeur</th>
            </tr>
            <tr>
              <td><b>Status</b></td>
              <td>
                <label class="opt"><input id="status_active" name="status" type="radio" value="ACTIVE"> ACTIVE</label>
                <label class="opt"><input id="status_done" name="status" type="radio" value="DONE"> DONE</label>
                <label class="opt"><input id="status_needs_retest" name="status" type="radio" value="NEEDS_RETEST"> NEEDS_RETEST</label>
                <label class="opt"><input id="status_risk" name="status" type="radio" value="RISK"> RISK</label>
              </td>
            </tr>
            <tr>
              <td><b>Toggles</b></td>
              <td>
                <label class="opt"><input id="toggle_sig_off" type="checkbox"> <span class="tag" data-tip="Kill-switch signature (coupe tous returns/throws).">[TOGGLE:SIG_OFF]</span></label>
                <label class="opt"><input id="toggle_ctrl_off" type="checkbox"> <span class="tag" data-tip="Coupe contr√¥les/compensations si tu veux isoler une cause.">[TOGGLE:CTRL_OFF]</span></label>
              </td>
            </tr>
            <tr>
              <td><b>Checkpoint actuel</b></td>
              <td>
                <a href="#checkpoints">[CHECKPOINT:PH2_LOCKED]</a> / <a href="#checkpoints">[CHECKPOINT:PH3_LOCKED]</a>
              </td>
            </tr>
            <tr>
              <td><b>RISK_BADGE</b></td>
              <td><input id="state_risk_badge" class="fill" placeholder="ex: FX sujet / nuage / mono fragile / groove cass√©"></td>
            </tr>
            <tr>
              <td><b>DEPENDS / REOPENS</b></td>
              <td>
                ‚ö† <a href="#depends">[DEPENDS_ON:P11]</a>&nbsp;
                ‚ö† <a href="#depends">[DEPENDS_ON:P8]</a>&nbsp;
                ‚ö† <a href="#depends">[DEPENDS_ON:P10]</a>&nbsp;
                / ‚ö† <a href="#depends">[REOPENS:P13]</a>
              </td>
            </tr>
          </table>
        </div>
      </section>

      <!-- 1) PATH PICKER -->
      <section class="card path" id="path" data-section>
        <header>
          <div class="h">
            <span class="tag">1) PATH</span>
            <span>PATH PICKER ‚Äî TRIAL ‚Üí COMMIT</span>
          </div>
          <div class="sub">TRIAL max 2 / COMMIT 1 obligatoire</div>
        </header>

        <div class="body">
          <table>
            <tr>
              <th>PATH</th>
              <th class="center">TRIAL</th>
              <th class="center">COMMIT</th>
              <th class="small">CROIX</th>
              <th>RISK_FOCUS</th>
              <th class="small">‚û° TECH PACK</th>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Ultra dry" data-croix="moins ‚Äúcin√©ma‚Äù" data-risk="plat / voix ‚Äúdans la t√™te‚Äù">
              <td>Ultra dry (front, docu, impact)</td>
              <td class="center"><input id="path_trial_ultradry" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_ultradry" class="path-commit" type="checkbox"></td>
              <td>moins ‚Äúcin√©ma‚Äù</td>
              <td>plat / voix ‚Äúdans la t√™te‚Äù</td>
              <td><a href="#tech-path-ultradry">Preset PATH:Ultra dry</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Tight room" data-croix="moins ‚Äúgrand monde‚Äù" data-risk="boxy/voile">
              <td>Tight room (proche, r√©aliste)</td>
              <td class="center"><input id="path_trial_tightroom" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_tightroom" class="path-commit" type="checkbox"></td>
              <td>moins ‚Äúgrand monde‚Äù</td>
              <td>boxy/voile</td>
              <td><a href="#tech-path-tightroom">Preset PATH:Tight room</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Plate luxe" data-croix="moins ‚Äúrap ultra sec‚Äù" data-risk="diction noy√©e si non duck√©e">
              <td>Plate luxe (halo dense, pop/classy)</td>
              <td class="center"><input id="path_trial_plateluxe" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_plateluxe" class="path-commit" type="checkbox"></td>
              <td>moins ‚Äúrap ultra sec‚Äù</td>
              <td>diction noy√©e si non duck√©e</td>
              <td><a href="#tech-path-plateluxe">Preset PATH:Plate luxe</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Chamber" data-croix="moins ‚Äúultra wide‚Äù" data-risk="flou si trop long">
              <td>Chamber (naturel, profondeur √©l√©gante)</td>
              <td class="center"><input id="path_trial_chamber" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_chamber" class="path-commit" type="checkbox"></td>
              <td>moins ‚Äúultra wide‚Äù</td>
              <td>flou si trop long</td>
              <td><a href="#tech-path-chamber">Preset PATH:Chamber</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Hall cinematic" data-croix="moins lisible" data-risk="tails envahissantes / FX sujet">
              <td>Hall cinematic (grand √©cran)</td>
              <td class="center"><input id="path_trial_hall" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_hall" class="path-commit" type="checkbox"></td>
              <td>moins lisible</td>
              <td>tails envahissantes / FX sujet</td>
              <td><a href="#tech-path-hall">Preset PATH:Hall cinematic</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Slapback" data-croix="moins profondeur longue" data-risk="r√©p√©tition audible / groove">
              <td>Slapback (√©paisseur / vibe)</td>
              <td class="center"><input id="path_trial_slapback" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_slapback" class="path-commit" type="checkbox"></td>
              <td>moins profondeur longue</td>
              <td>r√©p√©tition audible / groove</td>
              <td><a href="#tech-path-slapback">Preset PATH:Slapback</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Delay rythmique" data-croix="moins naturalit√©" data-risk="masque texte / pattern dominant">
              <td>Delay rythmique (bounce, groove)</td>
              <td class="center"><input id="path_trial_delay" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_delay" class="path-commit" type="checkbox"></td>
              <td>moins naturalit√©</td>
              <td>masque texte / pattern dominant</td>
              <td><a href="#tech-path-delay">Preset PATH:Delay rythmique</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Ping-pong wide" data-croix="moins mono b√©ton" data-risk="centre instable / corr√©lation">
              <td>Ping-pong wide (sc√®ne large)</td>
              <td class="center"><input id="path_trial_pingpong" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_pingpong" class="path-commit" type="checkbox"></td>
              <td>moins mono b√©ton</td>
              <td>centre instable / corr√©lation</td>
              <td><a href="#tech-path-pingpong">Preset PATH:Ping-pong wide</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Throws/Multi-tap" data-croix="moins monde stable" data-risk="gimmick r√©p√©titif">
              <td>Throws / multi-tap (ponctuation)</td>
              <td class="center"><input id="path_trial_throws" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_throws" class="path-commit" type="checkbox"></td>
              <td>moins monde stable</td>
              <td>gimmick r√©p√©titif</td>
              <td><a href="#tech-path-throws">Preset PATH:Throws/Multi-tap</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Signature" data-croix="moins robustesse universelle" data-risk="fatigue / FX sujet / mono">
              <td>Signature (reverse/gated/shimmer/blackhole)</td>
              <td class="center"><input id="path_trial_signature" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_signature" class="path-commit" type="checkbox"></td>
              <td>moins robustesse universelle</td>
              <td>fatigue / FX sujet / mono</td>
              <td><a href="#tech-path-signature">Preset PATH:Signature</a></td>
            </tr>

            <tr class="path-row" data-kind="path-row" data-path="Convolution sp√©ciale" data-croix="moins contr√¥le simple" data-risk="r√©sonances / monde incoh√©rent">
              <td>Convolution sp√©ciale (IR ‚Äúweird space‚Äù)</td>
              <td class="center"><input id="path_trial_convolution" class="path-trial" type="checkbox"></td>
              <td class="center"><input id="path_commit_convolution" class="path-commit" type="checkbox"></td>
              <td>moins contr√¥le simple</td>
              <td>r√©sonances / monde incoh√©rent</td>
              <td><a href="#tech-path-convolution">Preset PATH:Convolution sp√©ciale</a></td>
            </tr>
          </table>

          <div class="hr"></div>
          <div class="muted">
            <b>R√®gles (factuelles)</b>
            <ul>
              <li>TRIAL : maximum 2 chemins coch√©s.</li>
              <li>COMMIT : 1 seul chemin coch√© (obligatoire).</li>
              <li>Si COMMIT non coch√© ‚Üí porte ‚â† DONE.</li>
              <li>Apr√®s COMMIT : pas de changement de chemin sans FAIL prouv√© + trigger not√©. <a class="ref" href="#r3-07" data-tip="Apr√®s COMMIT, tu ne changes pas de monde sans FAIL prouv√© + trigger not√©.">[REF:R3-07]</a></li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 1bis) TARGET -->
      <section class="card target" id="target" data-section>
        <header>
          <div class="h">
            <span class="tag">1bis) TARGET</span>
            <span>TARGET PICKER ‚Äî SCOPE</span>
          </div>
          <div class="sub">PRIMARY 1 obligatoire / SECONDARY 0‚Äì2</div>
        </header>

        <div class="body">
          <table>
            <tr>
              <th>TARGET</th>
              <th class="center">PRIMARY</th>
              <th class="center">SECONDARY</th>
              <th class="small">DEFAULT/COND</th>
              <th class="small">BUT</th>
              <th>RISK_FOCUS</th>
              <th class="small">‚û° TECH PACK</th>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="RETURNS">
              <td>RETURNS (reverb/delay buses)</td>
              <td class="center"><input id="target_primary_returns" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_returns" class="target-secondary" type="checkbox"></td>
              <td>DEFAULT</td>
              <td>sc√®ne stable</td>
              <td>boue / fizz</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="LEAD">
              <td>LEAD (sends depuis lead)</td>
              <td class="center"><input id="target_primary_lead" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_lead" class="target-secondary" type="checkbox"></td>
              <td>COND</td>
              <td>plan avant</td>
              <td>lead recule</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="DOUBLES/BACKS">
              <td>DOUBLES / BACKS</td>
              <td class="center"><input id="target_primary_doubles" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_doubles" class="target-secondary" type="checkbox"></td>
              <td>COND</td>
              <td>reculer couches</td>
              <td>secondaires devant</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="HARMONIES">
              <td>HARMONIES</td>
              <td class="center"><input id="target_primary_harmonies" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_harmonies" class="target-secondary" type="checkbox"></td>
              <td>COND</td>
              <td>profondeur</td>
              <td>flou</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="ADLIBS">
              <td>ADLIBS</td>
              <td class="center"><input id="target_primary_adlibs" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_adlibs" class="target-secondary" type="checkbox"></td>
              <td>COND</td>
              <td>accent/throws</td>
              <td>gimmick</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="CHOPS">
              <td>CHOPS</td>
              <td class="center"><input id="target_primary_chops" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_chops" class="target-secondary" type="checkbox"></td>
              <td>COND</td>
              <td>ponctuation</td>
              <td>masque</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="BUS VOCAL">
              <td>BUS VOCAL</td>
              <td class="center"><input id="target_primary_busvocal" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_busvocal" class="target-secondary" type="checkbox"></td>
              <td>RARE</td>
              <td>monde commun</td>
              <td>cumul invisible</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>

            <tr class="target-row" data-kind="target-row" data-target="MIXBUS">
              <td>MIXBUS (rare)</td>
              <td class="center"><input id="target_primary_mixbus" class="target-primary" type="checkbox"></td>
              <td class="center"><input id="target_secondary_mixbus" class="target-secondary" type="checkbox"></td>
              <td>RARE</td>
              <td>colle globale</td>
              <td>cumul</td>
              <td><a href="#tech-target-p13">Preset TARGET:P13</a></td>
            </tr>
          </table>

          <div class="hr"></div>
          <div class="muted">
            <b>R√®gles</b>
            <ul>
              <li>PRIMARY : 1 seul r√¥le coch√© (obligatoire).</li>
              <li>SECONDARY : 0‚Äì2 max.</li>
              <li>Par d√©faut : PRIMARY = RETURNS.</li>
              <li>Si aucun PRIMARY ‚Üí porte ‚â† DONE.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- CORE -->
      <section class="card core" id="core" data-section>
        <header>
          <div class="h">
            <span class="tag"><svg><use href="#i-check"/></svg>[CORE]</span>
            <span>Ex√©cution</span>
          </div>
          <div class="sub">10‚Äì20 lignes max (imp√©ratif, preuves, STOP)</div>
        </header>

        <div class="body">
          <ul>
            <li><b>Objectif</b> : mettre en sc√®ne la voix (plan + hi√©rarchie), pas d√©corer.</li>
            <li><b>Grande question</b> : l‚Äôespace prend-il la place du message (lead recule, diction floue, plans illisibles) ?</li>
            <li><b>Contrat garanti</b> : si PASS, la lead reste devant, les couches restent derri√®re, et l‚Äôespace se ressent sans attirer l‚Äôattention. <a class="ref" href="#r3-04" data-tip="Centre sacr√© : la lead reste devant, l'espace se ressent sans voler le message.">[REF:R3-04]</a></li>
            <li><b>D√©cision principale</b> : choisir un seul monde par section, puis doser via SEND/RETURN (pas ‚Äúau hasard‚Äù partout).</li>
            <li><b>Sortie attendue</b> : profondeur lisible (centre sacr√©), coh√©rence par section, throws choisis, groove intact. <a class="ref" href="#r3-16" data-tip="Coh√©rence inter-sections : un monde par section, sauf intention volontaire.">[REF:R3-16]</a></li>
            <li><b>Interdits</b> : juger ‚Äúmieux‚Äù parce que plus fort, empiler 5 espaces, utiliser la reverb pour ‚Äúfaire exister‚Äù la voix. <a class="ref" href="#r3-03" data-tip="Si la reverb sert √† r√©parer la pr√©sence, rollback Phase 2.">[REF:R3-03]</a></li>
            <li><b>LISTEN</b> : <span class="tag">[LISTEN:Plan]</span> <span class="tag">[LISTEN:Diction]</span> <span class="tag">[LISTEN:Groove]</span></li>
            <li><b>Preuve</b> : A/B level-match (bypass) + A/B <span class="tag" data-tip="Kill-switch signature : coupe tous returns/throws pour v√©rifier que le dry tient.">[TOGGLE:SIG_OFF]</span> vs ON (level-match). <a class="ref" href="#r3-05" data-tip="Level-match obligatoire (sinon biais volume).">[REF:R3-05]</a> <a class="ref" href="#r3-02" data-tip="SIG_OFF vs ON est une preuve non-skippable pour DONE.">[REF:R3-02]</a></li>
            <li><b>Dry doit tenir</b> : si la lead ‚Äútombe‚Äù quand SIG OFF, le probl√®me est ailleurs ‚Üí rollback Phase 2. <a class="ref" href="#r3-11" data-tip="Le dry doit tenir avant/apr√®s.">[REF:R3-11]</a> <a class="ref" href="#r3-03">[REF:R3-03]</a></li>
            <li><b>Routing-first</b> : d√©clare o√π vit l‚Äôespace (1‚Äì2 returns fixes + throws) avant de toucher les r√©glages. <a class="ref" href="#r3-13" data-tip="Routing-first : d'abord o√π vit l'effet, ensuite seulement les param√®tres.">[REF:R3-13]</a></li>
          </ul>

          <div class="hr"></div>

          <table>
            <tr>
              <th style="width:220px;">Champ</th>
              <th>Valeur</th>
            </tr>
            <tr>
              <td><b>PATH_COMMIT</b></td>
              <td>
                <input id="core_path_commit" class="fill" placeholder="auto-rempli au COMMIT (ex: Plate luxe)">
                <div class="hr"></div>
                <div style="display:grid;grid-template-columns: 1fr 1fr; gap:10px;">
                  <div><b>CROIX</b><input id="core_croix" class="fill" placeholder="auto-rempli (ex: moins rap ultra sec)"></div>
                  <div><b>RISK_FOCUS</b><input id="core_risk_focus" class="fill" placeholder="auto-rempli (ex: diction noy√©e si non duck√©e)"></div>
                </div>
              </td>
            </tr>
            <tr>
              <td><b>TARGET_PRIMARY</b></td>
              <td><input id="core_target_primary" class="fill" placeholder="auto-rempli (ex: RETURNS)"></td>
            </tr>
            <tr>
              <td><b>TARGET_SECONDARY</b></td>
              <td><input id="core_target_secondary" class="fill" placeholder='auto-rempli ("Aucun" si vide)'></td>
            </tr>
            <tr>
              <td><b>SCAN</b></td>
              <td class="muted">plan avant/arri√®re ‚Üí consonnes ‚Üí fins de phrases ‚Üí mono ‚Üí groove (1 intention √† la fois).</td>
            </tr>
            <tr>
              <td><b>CONSTATS</b></td>
              <td><input id="core_constats" class="fill" placeholder="1 phrase avant correction ‚Üí NOTES‚ÄîPorte (ou NOTES‚ÄîOREILLE_NEUVE)"></td>
            </tr>
          </table>

          <div class="hr"></div>

          <div class="muted">
            <b>R√©f√©rence</b> (si utilis√©e) : preuve cadr√©e uniquement. <a class="ref" href="#r3-08" data-tip="R√©f√©rence = preuve cadr√©e (pas de jugement global).">[REF:R3-08]</a><br/>
            <b>Si OREILLE_NEUVE</b> d√©clench√©e ‚Üí NOTES‚ÄîOREILLE_NEUVE<br/>
            <b>Pauses/√©coutes externes</b> = Intro Phase 3 (ne pas recopier).
          </div>

          <div class="hr"></div>

          <div class="stop"><b>STOP</b> : si ‚Äúmieux‚Äù seulement parce que plus fort ‚Üí level-match ‚Üí re-d√©cide, sinon refuse. <a class="ref" href="#r3-05">[REF:R3-05]</a></div>
          <div class="stop"><b>STOP</b> : si la lead recule ‚Üí baisse l‚Äôespace (un levier) ‚Üí re-test. <a class="ref" href="#r3-04">[REF:R3-04]</a></div>
          <div class="stop"><b>STOP</b> : si la diction se noie ‚Üí espace doit se retirer pendant la phrase (un levier) ‚Üí re-test. <a class="ref" href="#r3-10">[REF:R3-10]</a></div>
          <div class="stop"><b>STOP</b> : si mono rend le centre instable/creux ‚Üí resserre ou remplace l‚Äôespace ‚Üí re-test. <a class="ref" href="#r3-04">[REF:R3-04]</a></div>
          <div class="stop"><b>STOP</b> : si l‚Äô√©cho casse le flow ‚Üí simplifie ou retire ‚Üí re-test. <a class="ref" href="#r3-10">[REF:R3-10]</a></div>
        </div>
      </section>

      <!-- TESTS -->
      <section class="card test" id="tests" data-section>
        <header>
          <div class="h">
            <span class="tag">2) [TEST:ALWAYS]</span>
            <span>Table PASS / FAIL / SKIP</span>
          </div>
          <div class="sub">20‚Äì40s / non-skippable pour ‚ÄúDONE‚Äù : SIG OFF vs ON</div>
        </header>

        <div class="body">
          <table id="tests_table">
            <tr>
              <th>Test</th>
              <th class="center">PASS</th>
              <th class="center">FAIL</th>
              <th class="center">SKIP</th>
              <th>Raison (si SKIP)</th>
            </tr>

            <!-- Helper: Each test row is a radio group. JS reads the group value. -->
            <tr data-kind="test-row" data-test="bas_volume">
              <td>Bas volume</td>
              <td class="center"><input id="t_bas_volume_pass" type="radio" name="test_bas_volume" value="PASS"></td>
              <td class="center"><input id="t_bas_volume_fail" type="radio" name="test_bas_volume" value="FAIL"></td>
              <td class="center"><input id="t_bas_volume_skip" type="radio" name="test_bas_volume" value="SKIP"></td>
              <td><input id="t_bas_volume_reason" class="fill" placeholder="raison: ___"></td>
            </tr>
            <tr data-kind="test-row" data-test="mono">
              <td>Mono</td>
              <td class="center"><input id="t_mono_pass" type="radio" name="test_mono" value="PASS"></td>
              <td class="center"><input id="t_mono_fail" type="radio" name="test_mono" value="FAIL"></td>
              <td class="center"><input id="t_mono_skip" type="radio" name="test_mono" value="SKIP"></td>
              <td><input id="t_mono_reason" class="fill" placeholder="raison: ___"></td>
            </tr>
            <tr data-kind="test-row" data-test="passage_dense">
              <td>Passage dense</td>
              <td class="center"><input id="t_dense_pass" type="radio" name="test_dense" value="PASS"></td>
              <td class="center"><input id="t_dense_fail" type="radio" name="test_dense" value="FAIL"></td>
              <td class="center"><input id="t_dense_skip" type="radio" name="test_dense" value="SKIP"></td>
              <td><input id="t_dense_reason" class="fill" placeholder="raison: ___"></td>
            </tr>
            <tr data-kind="test-row" data-test="ab_bypass">
              <td>A/B level-match (bypass) <a class="ref" href="#r3-05" data-tip="Level-match obligatoire (sinon biais volume).">[REF:R3-05]</a></td>
              <td class="center"><input id="t_ab_bypass_pass" type="radio" name="test_ab_bypass" value="PASS"></td>
              <td class="center"><input id="t_ab_bypass_fail" type="radio" name="test_ab_bypass" value="FAIL"></td>
              <td class="center"><input id="t_ab_bypass_skip" type="radio" name="test_ab_bypass" value="SKIP"></td>
              <td><input id="t_ab_bypass_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <!-- REQUIRED: SIG OFF vs ON must not be SKIP -->
            <tr data-kind="test-row" data-test="sig_ab" data-required="true">
              <td><b>A/B [TOGGLE:SIG_OFF] vs ON (level-match)</b> ‚Üê FIXE / NON SKIPPABLE POUR ‚ÄúDONE‚Äù <a class="ref" href="#r3-02" data-tip="Non-skippable pour DONE : preuve kill-switch.">[REF:R3-02]</a></td>
              <td class="center"><input id="t_sig_pass" type="radio" name="test_sig" value="PASS"></td>
              <td class="center"><input id="t_sig_fail" type="radio" name="test_sig" value="FAIL"></td>
              <td class="center"><input id="t_sig_skip" type="radio" name="test_sig" value="SKIP"></td>
              <td><input id="t_sig_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <!-- REQUIRED: PATH_COMMIT valid√© must not be SKIP -->
            <tr data-kind="test-row" data-test="path_commit" data-required="true">
              <td>PATH_COMMIT valid√© (A/B level-match) ‚Üê si SKIP ‚Üí porte ‚â† DONE</td>
              <td class="center"><input id="t_path_commit_pass" type="radio" name="test_path_commit" value="PASS"></td>
              <td class="center"><input id="t_path_commit_fail" type="radio" name="test_path_commit" value="FAIL"></td>
              <td class="center"><input id="t_path_commit_skip" type="radio" name="test_path_commit" value="SKIP"></td>
              <td><input id="t_path_commit_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr>
              <th colspan="5">Tests uniques P13</th>
            </tr>

            <tr data-kind="test-row" data-test="check0">
              <td>Check 0 ‚Äúmieux = plus fort ?‚Äù (return level-match)</td>
              <td class="center"><input id="t_check0_pass" type="radio" name="test_check0" value="PASS"></td>
              <td class="center"><input id="t_check0_fail" type="radio" name="test_check0" value="FAIL"></td>
              <td class="center"><input id="t_check0_skip" type="radio" name="test_check0" value="SKIP"></td>
              <td><input id="t_check0_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="lead_front">
              <td>Lead reste au premier plan quand l‚Äôeffet appara√Æt</td>
              <td class="center"><input id="t_lead_front_pass" type="radio" name="test_lead_front" value="PASS"></td>
              <td class="center"><input id="t_lead_front_fail" type="radio" name="test_lead_front" value="FAIL"></td>
              <td class="center"><input id="t_lead_front_skip" type="radio" name="test_lead_front" value="SKIP"></td>
              <td><input id="t_lead_front_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="diction">
              <td>Diction (consonnes) lisible quand l‚Äôeffet appara√Æt</td>
              <td class="center"><input id="t_diction_pass" type="radio" name="test_diction" value="PASS"></td>
              <td class="center"><input id="t_diction_fail" type="radio" name="test_diction" value="FAIL"></td>
              <td class="center"><input id="t_diction_skip" type="radio" name="test_diction" value="SKIP"></td>
              <td><input id="t_diction_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="fins">
              <td>Fins de phrases propres (pas de nuage)</td>
              <td class="center"><input id="t_fins_pass" type="radio" name="test_fins" value="PASS"></td>
              <td class="center"><input id="t_fins_fail" type="radio" name="test_fins" value="FAIL"></td>
              <td class="center"><input id="t_fins_skip" type="radio" name="test_fins" value="SKIP"></td>
              <td><input id="t_fins_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="groove">
              <td>Groove respect√© (delay ne parasite pas)</td>
              <td class="center"><input id="t_groove_pass" type="radio" name="test_groove" value="PASS"></td>
              <td class="center"><input id="t_groove_fail" type="radio" name="test_groove" value="FAIL"></td>
              <td class="center"><input id="t_groove_skip" type="radio" name="test_groove" value="SKIP"></td>
              <td><input id="t_groove_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="coherence">
              <td>Coh√©rence par section (pas de ‚Äúchangement de pi√®ce‚Äù accidentel)</td>
              <td class="center"><input id="t_coherence_pass" type="radio" name="test_coherence" value="PASS"></td>
              <td class="center"><input id="t_coherence_fail" type="radio" name="test_coherence" value="FAIL"></td>
              <td class="center"><input id="t_coherence_skip" type="radio" name="test_coherence" value="SKIP"></td>
              <td><input id="t_coherence_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr>
              <th colspan="5">(si TARGET_PRIMARY ‚â† LEAD) OU (TARGET_SECONDARY ‚â† ‚ÄúAucun‚Äù) : tests supports</th>
            </tr>

            <tr data-kind="test-row" data-test="mute_supports" data-support="true">
              <td>Mute SUPPORTS</td>
              <td class="center"><input id="t_mute_supports_pass" type="radio" name="test_mute_supports" value="PASS"></td>
              <td class="center"><input id="t_mute_supports_fail" type="radio" name="test_mute_supports" value="FAIL"></td>
              <td class="center"><input id="t_mute_supports_skip" type="radio" name="test_mute_supports" value="SKIP"></td>
              <td><input id="t_mute_supports_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="mute_lead" data-support="true">
              <td>Mute LEAD</td>
              <td class="center"><input id="t_mute_lead_pass" type="radio" name="test_mute_lead" value="PASS"></td>
              <td class="center"><input id="t_mute_lead_fail" type="radio" name="test_mute_lead" value="FAIL"></td>
              <td class="center"><input id="t_mute_lead_skip" type="radio" name="test_mute_lead" value="SKIP"></td>
              <td><input id="t_mute_lead_reason" class="fill" placeholder="raison: ___"></td>
            </tr>

            <tr data-kind="test-row" data-test="side_only" data-support="true">
              <td>Side-only</td>
              <td class="center"><input id="t_side_only_pass" type="radio" name="test_side_only" value="PASS"></td>
              <td class="center"><input id="t_side_only_fail" type="radio" name="test_side_only" value="FAIL"></td>
              <td class="center"><input id="t_side_only_skip" type="radio" name="test_side_only" value="SKIP"></td>
              <td><input id="t_side_only_reason" class="fill" placeholder="raison: ___"></td>
            </tr>
          </table>

          <div class="hr"></div>
          <div class="muted">
            <b>R√®gles</b>
            <ul>
              <li>PASS partout ‚Üí ne rien ouvrir ‚Üí HANDOFF + JOURNAL ‚Üí porte suivante.</li>
              <li>Si SIG OFF vs ON est SKIP ‚Üí porte ‚â† DONE.</li>
              <li>Si PATH_COMMIT valid√© = SKIP ‚Üí porte ‚â† DONE.</li>
              <li>Si tests supports requis et tous SKIP ‚Üí porte ‚â† DONE.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 12) HANDOFF -->
      <section class="card core" id="handoff" data-section>
        <header>
          <div class="h">
            <span class="tag">12) HANDOFF</span>
            <span>Sortie (3 lignes max)</span>
          </div>
          <div class="sub">Ce que tu ‚Äúg√®les‚Äù si PASS</div>
        </header>

        <div class="body">
          <ul>
            <li><b>ON/OFF</b> : monde d‚Äôespace d√©clar√© ; returns contr√¥lables ; SIG OFF = preuve. <a class="ref" href="#r3-02">[REF:R3-02]</a></li>
            <li><b>RISK_BADGE + trigger</b> (si fragile) : <input id="handoff_risk" class="fill" placeholder="______"> ; r√©ouvrir seulement sur FAIL prouv√©. <a class="ref" href="#r3-18">[REF:R3-18]</a></li>
            <li><b>Next door</b> : lien vers P14 ‚Äî Largeur / couches / architecture.</li>
          </ul>
        </div>
      </section>

      <!-- Titre 4 repli√©s -->
      <details class="card fail" id="redflags" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag"><svg><use href="#i-warn"/></svg>[IF:FAIL]</span>
            <span>3) RED FLAGS (FAIL direct) ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <ul>
              <li>‚Äú√áa marche‚Äù seulement quand tu montes l‚Äôeffet (return) ‚Üí FAIL (biais de volume).</li>
              <li>L‚Äôespace vole le premier plan (lead recule) ‚Üí FAIL.</li>
              <li>L‚Äôeffet concurrence le texte (consonnes noy√©es) ‚Üí FAIL.</li>
              <li>Tails empilent les phrases (nuage permanent) ‚Üí FAIL.</li>
              <li>Le delay casse le groove ‚Üí FAIL.</li>
              <li>En mono, centre instable ou voix creuse ‚Üí FAIL. <a class="ref" href="#r3-04">[REF:R3-04]</a></li>
              <li>Tu ne peux pas d√©crire simplement ‚Äúo√π est‚Äù la voix ‚Üí FAIL.</li>
              <li>Tu utilises l‚Äôespace comme b√©quille pour ‚Äúfaire exister‚Äù la lead ‚Üí FAIL ‚Üí rollback Phase 2. <a class="ref" href="#r3-03">[REF:R3-03]</a></li>
            </ul>
          </div>
        </div>
      </details>

      <details class="card fail" id="sigfail" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag"><svg><use href="#i-warn"/></svg>[IF:FAIL]</span>
            <span>4) SYMPT√îMES SIGNATURE ‚Üí ACTION (RUN) ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <h3 style="margin:0 0 8px;">A) Universels</h3>

            <div class="stop">
              <b>SYMPT√îME</b> : ‚Äúmieux‚Äù seulement parce que plus fort (CHECK 0)<br/>
              <b>CAUSE</b> : biais volume / effet non d√©fendu √† niveau r√©el<br/>
              <b>ACTION</b> : level-match le return (un levier)<br/>
              <b>RE-TEST</b> : A/B bypass (level-match) + Bas volume<br/>
              <b>STOP</b> : si c‚Äôest mieux √† niveau √©gal, sinon refuse <a class="ref" href="#r3-05">[REF:R3-05]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : la lead recule d√®s que l‚Äôespace appara√Æt<br/>
              <b>CAUSE</b> : trop d‚Äôespace sur le centre / plan avant-arri√®re non d√©cid√©<br/>
              <b>ACTION</b> : r√©duire l‚Äôespace sur la lead (un levier)<br/>
              <b>RE-TEST</b> : Lead au premier plan + Passage dense<br/>
              <b>STOP</b> : si le centre redevient sacr√© <a class="ref" href="#r3-04">[REF:R3-04]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : consonnes/syllabes se noient quand l‚Äôeffet appara√Æt<br/>
              <b>CAUSE</b> : timing d‚Äôeffet qui parle pendant la phrase<br/>
              <b>ACTION</b> : faire se retirer l‚Äôeffet pendant la diction (un levier)<br/>
              <b>RE-TEST</b> : Diction lisible + Passage dense<br/>
              <b>STOP</b> : si la phrase reste nette <a class="ref" href="#r3-10">[REF:R3-10]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : fins de phrases = nuage / phrases qui se collent<br/>
              <b>CAUSE</b> : dur√©e trop longue pour le d√©bit / trop d‚Äôinfos restent ‚Äúen l‚Äôair‚Äù<br/>
              <b>ACTION</b> : raccourcir l‚Äôespace (un levier)<br/>
              <b>RE-TEST</b> : Fins propres + Passage dense<br/>
              <b>STOP</b> : si les silences respirent
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : fatigue rapide / ‚Äúair‚Äù qui pique dans l‚Äôambiance<br/>
              <b>CAUSE</b> : trop de haut dans l‚Äôespace / l‚Äôeffet attire l‚Äôattention<br/>
              <b>ACTION</b> : assombrir l‚Äôespace (un levier)<br/>
              <b>RE-TEST</b> : Bas volume + <span class="tag">[LISTEN:Plan]</span><br/>
              <b>STOP</b> : si l‚Äôespace se ressent sans briller
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : boue/voile ajout√© par l‚Äôespace<br/>
              <b>CAUSE</b> : bas et bas-m√©dium dans le return<br/>
              <b>ACTION</b> : enlever le bas de l‚Äôespace (un levier)<br/>
              <b>RE-TEST</b> : Passage dense + Bas volume<br/>
              <b>STOP</b> : si la clart√© revient
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : taille d‚Äôespace change phrase par phrase sans intention<br/>
              <b>CAUSE</b> : d√©cisions locales incoh√©rentes / variations au hasard<br/>
              <b>ACTION</b> : unifier l‚Äôespace par section (un levier)<br/>
              <b>RE-TEST</b> : Coh√©rence section + A/B SIG OFF vs ON<br/>
              <b>STOP</b> : si ‚Äúun monde‚Äù tient <a class="ref" href="#r3-16">[REF:R3-16]</a> <a class="ref" href="#r3-02">[REF:R3-02]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME</b> : l‚Äô√©cho parasite le flow / salit le groove<br/>
              <b>CAUSE</b> : r√©p√©titions trop audibles ou mal plac√©es<br/>
              <b>ACTION</b> : simplifier les r√©p√©titions (un levier)<br/>
              <b>RE-TEST</b> : Groove respect√© + Passage dense<br/>
              <b>STOP</b> : si le d√©bit redevient net <a class="ref" href="#r3-10">[REF:R3-10]</a>
            </div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;">B) Sp√©cifiques au PATH_COMMIT</h3>

            <div class="stop">
              <b>[PATH:Ultra dry]</b><br/>
              SYMPT√îME : voix trop s√®che / ‚Äúdans ta t√™te‚Äù / pas de sc√®ne<br/>
              CAUSE : aucun espace commun minimal<br/>
              ACTION : ajouter un espace commun discret (un levier)<br/>
              RE-TEST : Bas volume + Lead au premier plan<br/>
              STOP : si la sc√®ne existe sans recul
            </div>

            <div class="stop">
              <b>[PATH:Tight room]</b><br/>
              SYMPT√îME : ‚Äúpi√®ce‚Äù boxy/nasale ou voile proche<br/>
              CAUSE : early trop pr√©sent / r√©sonance de pi√®ce<br/>
              ACTION : r√©duire la partie ‚Äúcollante‚Äù de l‚Äôespace (un levier)<br/>
              RE-TEST : Diction + Passage dense<br/>
              STOP : si √ßa colle sans colorer
            </div>

            <div class="stop">
              <b>[PATH:Plate luxe]</b><br/>
              SYMPT√îME : halo flatteur mais diction moins nette<br/>
              CAUSE : queue trop pr√©sente pendant la phrase<br/>
              ACTION : faire se retirer la plate pendant la diction (un levier)<br/>
              RE-TEST : Diction + Fins propres<br/>
              STOP : si le halo devient ‚Äúressenti‚Äù (pas entendu)
            </div>

            <div class="stop">
              <b>[PATH:Hall cinematic / Signature]</b><br/>
              SYMPT√îME : FX sujet / tails envahissantes / fatigue<br/>
              CAUSE : ambition d‚Äôespace &gt; message<br/>
              ACTION : rendre l‚Äôeffet ponctuel ou secondaire (un levier)<br/>
              RE-TEST : Lead au premier plan + Mono<br/>
              STOP : si l‚Äôeffet sert le film sans voler le texte <a class="ref" href="#r3-10">[REF:R3-10]</a>
            </div>

            <div class="stop">
              <b>[PATH:Delay rythmique / Ping-pong wide]</b><br/>
              SYMPT√îME : pattern plus m√©morable que la phrase / mono fragile<br/>
              CAUSE : motif trop dominant / largeur trop marqu√©e<br/>
              ACTION : r√©duire la dominance (un levier)<br/>
              RE-TEST : Groove + Mono<br/>
              STOP : si la topline gagne et le centre tient <a class="ref" href="#r3-04">[REF:R3-04]</a>
            </div>

            <div class="stop">
              <b>[PATH:Convolution sp√©ciale]</b><br/>
              SYMPT√îME : monde incoh√©rent / r√©sonances qui accrochent<br/>
              CAUSE : IR signature non au service<br/>
              ACTION : refuser ou remplacer l‚ÄôIR (un levier)<br/>
              RE-TEST : Coh√©rence section + Passage dense<br/>
              STOP : si ‚Äúun monde‚Äù tient
            </div>

            <div class="hr"></div>
            <h3 style="margin:0 0 8px;">C) Sp√©cifiques au TARGET</h3>

            <div class="stop">
              SYMPT√îME : les backs/doubles deviennent trop ‚Äúdevant‚Äù<br/>
              CAUSE : espace flatteur sur secondaires / plan arri√®re non assum√©<br/>
              ACTION : reculer les couches secondaires (un levier)<br/>
              RE-TEST : Mute SUPPORTS + Passage dense<br/>
              STOP : si le message reste au centre <a class="ref" href="#r3-04">[REF:R3-04]</a>
            </div>

            <div class="stop">
              SYMPT√îME : les c√¥t√©s paraissent plus proches que le centre<br/>
              CAUSE : proximit√© per√ßue sur sides / profondeur mal r√©partie<br/>
              ACTION : r√©duire la proximit√© des c√¥t√©s (un levier)<br/>
              RE-TEST : Side-only + Bas volume<br/>
              STOP : si le centre redevient dominant <a class="ref" href="#r3-04">[REF:R3-04]</a>
            </div>

            <div class="stop">
              SYMPT√îME : deux mondes (voix coll√©e + ambiance lointaine)<br/>
              CAUSE : √©cart direct/espace trop grand<br/>
              ACTION : rapprocher l‚Äôespace du direct (un levier)<br/>
              RE-TEST : Passage dense + <span class="tag">[LISTEN:Plan]</span><br/>
              STOP : si la sc√®ne se colle sans reculer la lead
            </div>

            <div class="stop">
              SYMPT√îME : en mono, la voix devient creuse √† cause des returns<br/>
              CAUSE : espace trop d√©corr√©l√© / annulations<br/>
              ACTION : remplacer par une version plus robuste (un levier)<br/>
              RE-TEST : Mono + A/B SIG OFF vs ON<br/>
              STOP : si mono reste acceptable <a class="ref" href="#r3-04">[REF:R3-04]</a> <a class="ref" href="#r3-02">[REF:R3-02]</a>
            </div>
          </div>
        </div>
      </details>

      <details class="card fail" id="soclefail" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag"><svg><use href="#i-warn"/></svg>[IF:FAIL]</span>
            <span>5) SYMPT√îMES SOCLE (retour Phase 2) ‚Üí ACTION ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <div class="stop">
              <b>SYMPT√îME SOCLE</b> : tu utilises l‚Äôespace pour ‚Äúfaire exister‚Äù la voix<br/>
              <b>CAUSE</b> : hi√©rarchie/place non r√©solue en amont<br/>
              <b>ACTION</b> : r√©duire l‚Äôespace et accepter le vide (un levier)<br/>
              <b>RE-TEST</b> : A/B SIG OFF vs ON + Bas volume<br/>
              <b>STOP</b> : si la lead tient sans b√©quille, sinon rollback Phase 2 (P8/P9/P10) <a class="ref" href="#r3-03">[REF:R3-03]</a> <a class="ref" href="#r3-01">[REF:R3-01]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME SOCLE</b> : la lead recule parce qu‚Äôelle manque de pr√©sence (m√™me sans FX)<br/>
              <b>CAUSE</b> : place/contr√¥le pas verrouill√©s en Phase 2<br/>
              <b>ACTION</b> : rollback Phase 2 sur la cause prouv√©e (un levier)<br/>
              <b>RE-TEST</b> : Bas volume + Passage dense<br/>
              <b>STOP</b> : si dry/SIG OFF tient, puis retour P13 <a class="ref" href="#r3-01">[REF:R3-01]</a> <a class="ref" href="#r3-11">[REF:R3-11]</a>
            </div>

            <div class="stop">
              <b>SYMPT√îME SOCLE</b> : sibilance/harsh r√©appara√Æt surtout ‚Äúdans l‚Äôair‚Äù<br/>
              <b>CAUSE</b> : contr√¥le amont fragile, l‚Äôespace expose les d√©fauts<br/>
              <b>ACTION</b> : rollback Phase 2 sur contr√¥le (un levier)<br/>
              <b>RE-TEST</b> : Passage dense + Bas volume<br/>
              <b>STOP</b> : si la base tient, puis retour P13 <a class="ref" href="#r3-01">[REF:R3-01]</a> <a class="ref" href="#r3-06">[REF:R3-06]</a>
            </div>
          </div>
        </div>
      </details>

      <details class="card tech" id="listen" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">[LISTEN]</span>
            <span>6) LISTEN PANELS ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <div class="stop">
              <b>[LISTEN:Plan]</b><br/>
              But : entendre ‚Äúcentre devant / couches derri√®re‚Äù en une phrase.<br/>
              Sympt√¥mes : h√©sitation, sc√®ne confuse, c√¥t√©s trop proches, deux mondes.<br/>
              1 levier : unifier le monde par section OU resserrer la largeur.<br/>
              Re-test : Mono + Lead au premier plan.<br/>
              STOP : si tu peux d√©crire le plan simplement.
            </div>
            <div class="stop">
              <b>[LISTEN:Diction]</b><br/>
              But : consonnes intactes quand l‚Äôespace appara√Æt.<br/>
              Sympt√¥mes : syllabes noy√©es, attaques mang√©es, S deviennent √©v√©nements.<br/>
              1 levier : faire se retirer l‚Äôeffet pendant la phrase (duck/timing) OU s√©parer le direct.<br/>
              Re-test : Passage dense + Diction lisible.<br/>
              STOP : si la phrase reste nette.
            </div>
            <div class="stop">
              <b>[LISTEN:Groove]</b><br/>
              But : delay/throws renforcent le d√©bit sans parasiter.<br/>
              Sympt√¥mes : √©cho ‚Äúr√©pond‚Äù au mauvais endroit, pattern domine.<br/>
              1 levier : simplifier les r√©p√©titions OU rendre le delay plus discret.<br/>
              Re-test : Passage dense + Groove respect√©.<br/>
              STOP : si le flow redevient √©vident.
            </div>
            <div class="muted"><b>[OPT] LISTEN SCAN</b> : Plan ‚Üí Diction ‚Üí Fins ‚Üí Mono ‚Üí Groove</div>
          </div>
        </div>
      </details>

      <details class="card tech" id="techpack" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">TECH</span>
            <span>7) TECH PACK ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <h3 style="margin:0 0 8px;">A) TECH PACK ‚Äî G√âN√âRAL P13</h3>
            <ul>
              <li>P13 = mise en sc√®ne : reverb/delay positionnent et hi√©rarchisent, ils ne d√©corent pas.</li>
              <li>Un bon espace se ressent sans attirer l‚Äôattention ; si tu l‚Äôentends d‚Äôabord, il est trop pr√©sent. <a class="ref" href="#r3-10" data-tip="Si l'FX devient le sujet ‚Üí recadrage.">[REF:R3-10]</a></li>
              <li>Principe : SEND/RETURN par d√©faut (dosage, coh√©rence, automation, EQ/duck sur l‚Äôeffet sans toucher au dry). <a class="ref" href="#r3-13">[REF:R3-13]</a></li>
              <li>Insert uniquement si ‚Äúdesign‚Äù assum√© ; sinon risque de voler le message. <a class="ref" href="#r3-10">[REF:R3-10]</a></li>
              <li>Syst√®me minimal : 1 espace commun + 1 espace d‚Äôaccent (throws).</li>
              <li>Check 0 anti-biais : d‚Äôabord return level-match, ensuite param√®tres. <a class="ref" href="#r3-05">[REF:R3-05]</a></li>
              <li>Filtrage returns : enlever bas, calmer haut ; sinon boue/fizz et fatigue. <a class="ref" href="#r3-06">[REF:R3-06]</a></li>
              <li>Si les ‚ÄúS‚Äù vivent dans l‚Äôambiance : traiter le return plut√¥t que tuer la lead. <a class="ref" href="#r3-10">[REF:R3-10]</a></li>
              <li>Centre sacr√© : d√©corr√©lation qui casse le centre = FAIL (mono/instabilit√©). <a class="ref" href="#r3-04">[REF:R3-04]</a></li>
              <li>Tempo/groove : delay doit tomber ‚Äúdans le film‚Äù. <a class="ref" href="#r3-10">[REF:R3-10]</a></li>
              <li>Coh√©rence : un seul monde par section ; changements accidentels = recadrage. <a class="ref" href="#r3-16">[REF:R3-16]</a></li>
              <li>Stutter delay : ‚Äúsc√®ne/throw‚Äù = P13 ; ‚Äúmoteur rythmique/perf‚Äù = P15.</li>
              <li>Si tu ne sais pas pourquoi tu ajoutes de l‚Äôespace, n‚Äôen ajoute pas. <a class="ref" href="#r3-09">[REF:R3-09]</a></li>
            </ul>

            <div class="hr"></div>
            <div class="muted">
              <b>[PARAMS:HIDDEN] Rep√®res concrets (retours FX)</b>
              <ul>
                <li>Filtrage return : couper bas + calmer haut ; possible creux bas-m√©dium si voile.</li>
                <li>Pr√©-delay : colle vs s√©paration (plus s√©par√© = plus audible).</li>
                <li>Decay/feedback : d√©bit rapide ‚Üí plus court ; lent ‚Üí peut respirer mais ducking devient prioritaire.</li>
                <li>Diffusion/width : plus lisse vs plus granuleux ; lead tol√®re une largeur mod√©r√©e (centre prioritaire).</li>
                <li>Combo robuste : reverb plus centr√©e + delay plus large (profondeur + largeur sans flouter le centre).</li>
                <li>Cha√Æne return : filtre ‚Üí contr√¥le agressivit√© ‚Üí contr√¥le dynamique/duck ‚Üí (option) couleur ‚Üí width/MS.</li>
              </ul>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px;">B) TECH PACK ‚Äî Preset PATH:</h3>

            <h4 id="tech-path-ultradry">Preset PATH:Ultra dry</h4>
            <ul>
              <li>Intention : impact, docu, texte au front.</li>
              <li>Risque : plat / voix ‚Äúdans la t√™te‚Äù.</li>
              <li>Checkpoint : espace commun minimal, discret, mono safe.</li>
              <li>Throws : rares, choisis.</li>
            </ul>

            <h4 id="tech-path-tightroom">Preset PATH:Tight room</h4>
            <ul>
              <li>Intention : ‚Äúdans la pi√®ce‚Äù, colle sans queue longue.</li>
              <li>Risque : boxy/voile si ER trop pr√©sents.</li>
              <li>Checkpoint : diction intacte en passage dense.</li>
            </ul>

            <h4 id="tech-path-plateluxe">Preset PATH:Plate luxe</h4>
            <ul>
              <li>Intention : halo dense moderne, classy.</li>
              <li>Risque : couvre la diction si non duck√©/tim√©.</li>
              <li>Checkpoint : consonnes + fins propres.</li>
            </ul>

            <h4 id="tech-path-chamber">Preset PATH:Chamber</h4>
            <ul>
              <li>Intention : naturel + profondeur √©l√©gante.</li>
              <li>Risque : flou si trop long.</li>
              <li>Checkpoint : coh√©rence section + bas volume.</li>
            </ul>

            <h4 id="tech-path-hall">Preset PATH:Hall cinematic</h4>
            <ul>
              <li>Intention : grand √©cran / profondeur.</li>
              <li>Risque : tails envahissantes, FX sujet, lead recule.</li>
              <li>Checkpoint : centre sacr√© + mono.</li>
            </ul>

            <h4 id="tech-path-slapback">Preset PATH:Slapback</h4>
            <ul>
              <li>Intention : √©paisseur/vibe, pr√©sence.</li>
              <li>Risque : r√©p√©tition audible, groove perturb√©.</li>
              <li>Checkpoint : groove + diction.</li>
            </ul>

            <h4 id="tech-path-delay">Preset PATH:Delay rythmique</h4>
            <ul>
              <li>Intention : bounce, r√©ponse rythmique.</li>
              <li>Risque : pattern domine, masque texte si non contr√¥l√©.</li>
              <li>Checkpoint : passage dense + ‚Äúphrase gagne‚Äù.</li>
            </ul>

            <h4 id="tech-path-pingpong">Preset PATH:Ping-pong wide</h4>
            <ul>
              <li>Intention : sc√®ne large, mouvement.</li>
              <li>Risque : mono/corr√©lation, centre instable.</li>
              <li>Checkpoint : mono + centre stable.</li>
            </ul>

            <h4 id="tech-path-throws">Preset PATH:Throws/Multi-tap</h4>
            <ul>
              <li>Intention : ponctuation (mot-cl√©, fin de phrase).</li>
              <li>Risque : gimmick r√©p√©titif / incoh√©rence monde.</li>
              <li>Checkpoint : coh√©rence section + groove.</li>
            </ul>

            <h4 id="tech-path-signature">Preset PATH:Signature</h4>
            <ul>
              <li>Intention : reverse/gated/shimmer/blackhole = signature assum√©e.</li>
              <li>Risque : fatigue, mono, FX sujet.</li>
              <li>Checkpoint : ponctuel + secondaire + centre sacr√©. <a class="ref" href="#r3-10">[REF:R3-10]</a> <a class="ref" href="#r3-04">[REF:R3-04]</a></li>
            </ul>

            <h4 id="tech-path-convolution">Preset PATH:Convolution sp√©ciale</h4>
            <ul>
              <li>Intention : IR atypiques pour un monde unique.</li>
              <li>Risque : r√©sonances IR / monde incoh√©rent.</li>
              <li>Checkpoint : coh√©rence section + passage dense.</li>
            </ul>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px;" id="tech-target-p13">C) TECH PACK ‚Äî Preset TARGET:P13</h3>
            <ul>
              <li>RETURNS = point de contr√¥le : filtre + contr√¥le dynamique sur returns, pas sur le dry.</li>
              <li>LEAD : sends dos√©s ; priorit√© au plan (devant), pas √† ‚Äúbeau‚Äù. <a class="ref" href="#r3-04">[REF:R3-04]</a></li>
              <li>DOUBLES/BACKS : plus loin = plus d‚Äôespace mais plus sombre et moins intelligible. <a class="ref" href="#r3-04">[REF:R3-04]</a></li>
              <li>ADLIBS/CHOPS : throws ponctuels ; √©viter gimmick constant. <a class="ref" href="#r3-10">[REF:R3-10]</a></li>
              <li>BUS VOCAL/MIXBUS : rare ; si utilis√©, d√©clarer et tester cumul invisible. <a class="ref" href="#r3-12">[REF:R3-12]</a> <a class="ref" href="#r3-13">[REF:R3-13]</a></li>
            </ul>
          </div>
        </div>
      </details>

      <details class="card bus" id="busmap" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">BUS</span>
            <span>8) [BUSMAP:P13] ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <b>[BUSMAP:P13]</b><br/>
            <div class="muted">Sch√©ma minimal</div>
            <ul>
              <li>1 BUS REVERB (espace commun)</li>
              <li>1 BUS DELAY (sc√®ne/largeur)</li>
              <li>(Option) 1 BUS THROWS (accents ponctuels)</li>
            </ul>
            <div class="muted"><b>R√®gles</b></div>
            <ul>
              <li>Sends post-fader par d√©faut ; pr√©-fader seulement si intention.</li>
              <li>Contr√¥le = d‚Äôabord return, ensuite send, puis param√®tres. <a class="ref" href="#r3-05">[REF:R3-05]</a></li>
              <li>ON/OFF attendu : SIG OFF coupe tous returns + throws ; SIG ON active uniquement returns commit + automation d√©clar√©e. <a class="ref" href="#r3-02">[REF:R3-02]</a></li>
            </ul>
            <div class="muted"><b>D√©cision d‚Äôordre ‚Äúmoteur vs tails‚Äù (pr√©pare P15)</b></div>
            <ul>
              <li>Si tu veux hacher le dry sans hacher les tails ‚Üí prendre les sends avant le moteur.</li>
              <li>Si tu veux hacher aussi les tails ‚Üí moteur sur bus vocal ou sur returns. <a class="ref" href="#r3-13">[REF:R3-13]</a></li>
            </ul>
          </div>
        </div>
      </details>

      <details class="card tech" id="depends" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">‚ö†</span>
            <span>10) DEPENDS / REOPENS ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <ul>
              <li>‚ö† [DEPENDS_ON:P11] : si le ‚Äúpersonnage‚Äù change sans intention (monde d‚Äôespace incoh√©rent), recadrer. <a class="ref" href="#r3-16">[REF:R3-16]</a></li>
              <li>‚ö† [DEPENDS_ON:P8] : si la place/hi√©rarchie n‚Äôest pas gagn√©e, P13 devient b√©quille. <a class="ref" href="#r3-03">[REF:R3-03]</a></li>
              <li>‚ö† [DEPENDS_ON:P10] : si sibilance/harsh fragile, l‚Äôespace expose et fatigue. <a class="ref" href="#r3-06">[REF:R3-06]</a></li>
              <li>‚ö† [REOPENS:P13] : si P15/P16 r√©v√®le : lead recule, nuage, groove cass√©, mono instable ‚Üí re-test P13. <a class="ref" href="#r3-07">[REF:R3-07]</a></li>
            </ul>
            <div class="muted">
              Triggers : FAIL prouv√© sur Check 0 / Lead plan / Diction / Fins / Groove / Mono / Coh√©rence section.
            </div>
          </div>
        </div>
      </details>

      <details class="card tech" id="checkpoints" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">CHK</span>
            <span>11) CHECKPOINTS ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <ul>
              <li><b>Quand</b> : si PATH = Hall/Signature/Ping-pong/Convolution OU si throws multiples.</li>
              <li><b>ON/OFF</b> : liste des returns actifs + automation d√©clar√©e + test SIG OFF. <a class="ref" href="#r3-02">[REF:R3-02]</a></li>
              <li><b>RISK_BADGE + trigger</b> : <input id="checkpoint_risk" class="fill" placeholder="______"> + ‚Äúr√©ouvrir seulement sur FAIL prouv√©‚Äù. <a class="ref" href="#r3-18">[REF:R3-18]</a></li>
              <li><b>Preuve √† conserver</b> : A/B bypass + A/B SIG OFF vs ON (level-match). <a class="ref" href="#r3-05">[REF:R3-05]</a></li>
            </ul>
          </div>
        </div>
      </details>

      <details class="card tech" id="notes" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">NOTES</span>
            <span>13) NOTES ‚Äî Porte (SCOPE=door) ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <table>
              <tr>
                <th style="width:200px;">Champ</th>
                <th>Texte</th>
              </tr>
              <tr>
                <td>TRIAL</td>
                <td><input id="notes_trial_1" class="fill" placeholder="+apport / -casse (1 phrase)"></td>
              </tr>
              <tr>
                <td>TRIAL</td>
                <td><input id="notes_trial_2" class="fill" placeholder="+apport / -casse (1 phrase)"></td>
              </tr>
              <tr>
                <td>CONSTATS</td>
                <td><input id="notes_constats" class="fill" placeholder="1 phrase"></td>
              </tr>
              <tr>
                <td>Apr√®s COMMIT</td>
                <td class="muted">chaque correction r√©f√©rence RISK_FOCUS ou CROIX (sinon FAIL).</td>
              </tr>
            </table>
          </div>
        </div>
      </details>

      <details class="card tech" id="journal" data-section>
        <summary>
          <span class="sum-left">
            <span class="tag">LOG</span>
            <span>14) JOURNAL ‚Äî 1 ligne minimum ‚Äî (Titre 4 repli√©)</span>
          </span>
          <svg class="chev"><use href="#i-chevron"/></svg>
        </summary>
        <div class="body">
          <div style="padding: var(--pad);">
            <table>
              <tr>
                <th>Date</th>
                <th>Porte</th>
                <th>PATH_COMMIT</th>
                <th>TARGET_PRIMARY</th>
                <th>Action</th>
                <th>R√©sultat</th>
                <th>NEEDS_RETEST</th>
                <th>RISK_BADGE</th>
              </tr>
              <tr>
                <td><input id="journal_date" class="fill" placeholder="YYYY-MM-DD"></td>
                <td>P13</td>
                <td><input id="journal_path" class="fill" placeholder="..."></td>
                <td><input id="journal_target" class="fill" placeholder="..."></td>
                <td><input id="journal_action" class="fill" placeholder="1 levier"></td>
                <td><input id="journal_result" class="fill" placeholder="PASS/FAIL"></td>
                <td><input id="journal_needs" class="fill" placeholder="oui/non"></td>
                <td><input id="journal_risk" class="fill" placeholder="..."></td>
              </tr>
            </table>
          </div>
        </div>
      </details>

      <!-- R3 refs -->
      <section class="card tech" id="r3" data-section>
        <header>
          <div class="h">
            <span class="tag">[REF]</span>
            <span>Ancres R3 (stubs)</span>
          </div>
          <div class="sub">Juste pour que les liens [REF:R3-xx] soient cliquables ici</div>
        </header>
        <div class="body muted">
          <div id="r3-01"><span class="ref" data-tip="PH2_LOCKED sacr√© / rollback.">[REF:R3-01]</span> PH2_LOCKED sacr√© / rollback.</div>
          <div id="r3-02"><span class="ref" data-tip="Kill-switch SIG_OFF + preuve A/B.">[REF:R3-02]</span> Kill-switch SIG_OFF + preuve A/B.</div>
          <div id="r3-03"><span class="ref" data-tip="Si ajout = r√©parer ‚Üí retour Phase 2.">[REF:R3-03]</span> Si ajout = r√©parer ‚Üí retour Phase 2.</div>
          <div id="r3-04"><span class="ref" data-tip="Centre sacr√© / lead devant.">[REF:R3-04]</span> Centre sacr√© / lead devant.</div>
          <div id="r3-05"><span class="ref" data-tip="Level-match obligatoire.">[REF:R3-05]</span> Level-match obligatoire.</div>
          <div id="r3-06"><span class="ref" data-tip="Zones √† risque (fatigue/sibilance/harsh).">[REF:R3-06]</span> Zones √† risque (fatigue/sibilance/harsh).</div>
          <div id="r3-07"><span class="ref" data-tip="Apr√®s COMMIT, r√©ouverture sur FAIL prouv√©.">[REF:R3-07]</span> Porte valid√©e = gel√©e ; r√©ouverture sur FAIL prouv√©.</div>
          <div id="r3-08"><span class="ref" data-tip="R√©f√©rence = preuve cadr√©e uniquement.">[REF:R3-08]</span> R√©f√©rence = preuve cadr√©e uniquement.</div>
          <div id="r3-09"><span class="ref" data-tip="1 intention = 1 geste = stop.">[REF:R3-09]</span> 1 intention = 1 geste = stop.</div>
          <div id="r3-10"><span class="ref" data-tip="FX devient le sujet ‚Üí recadrage.">[REF:R3-10]</span> FX devient le sujet ‚Üí recadrage.</div>
          <div id="r3-11"><span class="ref" data-tip="Dry doit tenir avant/apr√®s.">[REF:R3-11]</span> Dry doit tenir avant/apr√®s.</div>
          <div id="r3-12"><span class="ref" data-tip="Cumul invisible interdit.">[REF:R3-12]</span> Cumul invisible interdit.</div>
          <div id="r3-13"><span class="ref" data-tip="Routing-first : o√π vit l‚Äôeffet.">[REF:R3-13]</span> Routing-first : o√π vit l‚Äôeffet.</div>
          <div id="r3-16"><span class="ref" data-tip="Coh√©rence inter-sections.">[REF:R3-16]</span> Coh√©rence inter-sections.</div>
          <div id="r3-18"><span class="ref" data-tip="Fragile = badge + trigger + micro-checkpoint.">[REF:R3-18]</span> Fragile = RISK_BADGE + trigger + micro-checkpoint.</div>
        </div>
      </section>

    </main>
  </div>

  <!-- RUN BAR sticky -->
  <div class="runbar" id="runbar">
    <div class="run-left">
      <button class="btn ghost" id="btn_run_mode" title="Replie les sections FAIL/TECH (mode RUN)">RUN</button>
      <button class="btn ghost" id="btn_fail_mode" title="Ouvre les sections FAIL (mode diagnostic)">FAIL</button>
      <button class="btn" id="btn_next_section" title="Aller √† la prochaine section (T3)"><svg><use href="#i-next"/></svg>Next</button>
      <button class="btn warn" id="btn_next_fail" title="Aller au premier FAIL / SKIP bloquant"><svg><use href="#i-warn"/></svg>Next FAIL</button>
    </div>

    <div class="progress">
      <div class="progress-top">
        <span id="progressText">0/0</span>
        <span class="muted" id="gateText">DONE: ‚Äî</span>
      </div>
      <div class="bar" id="progressBar"><div></div></div>
    </div>

    <div class="run-right">
      <button class="btn" id="btn_open_palette_2" title="Ctrl+K"><svg><use href="#i-search"/></svg>Palette</button>
      <button class="btn primary" id="btn_mark_done" disabled title="DONE impossible: SIG OFF/ON + PATH_COMMIT requis."><svg><use href="#i-check"/></svg>Mark DONE</button>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="palette-backdrop" id="paletteBackdrop" aria-hidden="true">
    <div class="palette" role="dialog" aria-modal="true" aria-label="Command palette">
      <div class="palette-head">
        <svg style="width:18px;height:18px;opacity:.9"><use href="#i-search"/></svg>
        <input id="paletteInput" placeholder="Tape une commande‚Ä¶ (ex: core, tests, tech, next fail) ‚Äî Esc pour fermer" />
      </div>
      <div class="palette-list" id="paletteList"></div>
    </div>
  </div>

  <script>
  (() => {
    const STORAGE_KEY = "P13_STATE_V2";
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    // ---------- Toast + Tooltip ----------
    function toast(msg) {
      let t = $("#toast");
      if (!t) {
        t = document.createElement("div");
        t.id = "toast";
        t.style.cssText = `
          position: fixed; bottom: 92px; left: 18px; z-index: 9999;
          background: rgba(20,20,24,.95); color: #fff; padding: 10px 12px;
          border-radius: 12px; font: 13px/1.2 system-ui; max-width: 420px;
          box-shadow: 0 10px 30px rgba(0,0,0,.35); opacity: 0; transform: translateY(8px);
          transition: .18s ease;
        `;
        document.body.appendChild(t);
      }
      t.textContent = msg;
      requestAnimationFrame(()=>{ t.style.opacity=1; t.style.transform="translateY(0)"; });
      clearTimeout(t._to);
      t._to = setTimeout(()=>{ t.style.opacity=0; t.style.transform="translateY(8px)"; }, 1600);
    }

    const tip = document.createElement("div");
    tip.className = "tip";
    document.body.appendChild(tip);

    function showTip(text, x, y){
      tip.textContent = text;
      tip.style.left = Math.min(window.innerWidth - 20, x + 12) + "px";
      tip.style.top  = Math.min(window.innerHeight - 20, y + 12) + "px";
      tip.classList.add("show");
    }
    function hideTip(){ tip.classList.remove("show"); }

    document.addEventListener("mousemove", (e) => {
      if (!tip.classList.contains("show")) return;
      tip.style.left = Math.min(window.innerWidth - 20, e.clientX + 12) + "px";
      tip.style.top  = Math.min(window.innerHeight - 20, e.clientY + 12) + "px";
    });
    document.addEventListener("mouseover", (e) => {
      const el = e.target.closest("[data-tip]");
      if (!el) return;
      showTip(el.getAttribute("data-tip"), e.clientX, e.clientY);
    });
    document.addEventListener("mouseout", (e) => {
      if (e.target.closest("[data-tip]")) hideTip();
    });

    // ---------- Save/Load (localStorage) ----------
    function saveState() {
      const data = {};
      $$("input, textarea, select").forEach(el => {
        if (!el.id) return;
        if (el.type === "checkbox" || el.type === "radio") data[el.id] = !!el.checked;
        else data[el.id] = el.value;
      });
      data.__density = document.body.getAttribute("data-density") || "comfy";
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      Object.entries(data).forEach(([id, val]) => {
        if (id === "__density") return;
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === "checkbox" || el.type === "radio") el.checked = !!val;
        else el.value = val;
      });
      if (data.__density) document.body.setAttribute("data-density", data.__density);
    }

    function bindAutoSave() {
      document.addEventListener("input", e => {
        if (e.target && e.target.id) saveState();
        updateProgress();
      });
      document.addEventListener("change", e => {
        if (e.target && e.target.id) saveState();
        // rules + UI refresh
        if (e.target.closest("[data-kind='path-row']")) enforcePathRules(e.target);
        if (e.target.closest("[data-kind='target-row']")) enforceTargetRules(e.target);
        refreshRowState();
        refreshGates();
        updateProgress();
      });
    }

    // ---------- PATH PICKER Rules ----------
    const pathRows = $$("[data-kind='path-row']");
    function enforcePathRules(changedEl) {
      const trials = pathRows.map(r => $(".path-trial", r)).filter(Boolean);
      const commits = pathRows.map(r => $(".path-commit", r)).filter(Boolean);

      // TRIAL max 2
      if (changedEl.classList.contains("path-trial")) {
        const trialChecked = trials.filter(c => c.checked);
        if (trialChecked.length > 2) {
          changedEl.checked = false;
          toast("TRIAL max = 2 chemins.");
          saveState();
          return;
        }
      }

      // COMMIT = 1 seul (radio-like)
      if (changedEl.classList.contains("path-commit") && changedEl.checked) {
        commits.forEach(c => { if (c !== changedEl) c.checked = false; });

        // Auto-fill CORE fields
        const row = changedEl.closest("[data-kind='path-row']");
        const path = row?.dataset.path || "";
        const croix = row?.dataset.croix || "";
        const risk = row?.dataset.risk || "";
        const fPath = $("#core_path_commit");
        const fCroix = $("#core_croix");
        const fRisk = $("#core_risk_focus");
        if (fPath) fPath.value = path;
        if (fCroix) fCroix.value = croix;
        if (fRisk) fRisk.value = risk;

        toast(`COMMIT: ${path}`);
        saveState();
      }
    }

    // ---------- TARGET PICKER Rules ----------
    const targetRows = $$("[data-kind='target-row']");
    function enforceTargetRules(changedEl) {
      const primaries = targetRows.map(r => $(".target-primary", r)).filter(Boolean);
      const secondaries = targetRows.map(r => $(".target-secondary", r)).filter(Boolean);

      // PRIMARY = 1 seul
      if (changedEl.classList.contains("target-primary") && changedEl.checked) {
        primaries.forEach(p => { if (p !== changedEl) p.checked = false; });
        const row = changedEl.closest("[data-kind='target-row']");
        const target = row?.dataset.target || "";
        const fPrim = $("#core_target_primary");
        if (fPrim) fPrim.value = target;
        toast(`PRIMARY: ${target}`);
        saveState();
      }

      // SECONDARY max 2
      if (changedEl.classList.contains("target-secondary")) {
        const secChecked = secondaries.filter(s => s.checked);
        if (secChecked.length > 2) {
          changedEl.checked = false;
          toast("SECONDARY max = 2 r√¥les.");
          saveState();
          return;
        }
        // Auto-fill SECONDARY list in CORE
        const secTargets = secChecked
          .map(s => s.closest("[data-kind='target-row']")?.dataset.target)
          .filter(Boolean);

        const fSec = $("#core_target_secondary");
        if (fSec) fSec.value = secTargets.length ? secTargets.join(", ") : "Aucun";
        saveState();
      }
    }

    // ---------- Active row highlight ----------
    function refreshRowState() {
      $$("tr.path-row, tr.target-row, tr[data-kind='test-row']").forEach(row => {
        const inputs = $$("input", row);
        const anyChecked = inputs.some(i => i.checked);
        row.classList.toggle("is-active", anyChecked);
      });
    }

    // ---------- Tests helpers ----------
    function groupValue(groupName){
      const checked = document.querySelector(`input[name="${groupName}"]:checked`);
      return checked ? checked.value : "";
    }

    function supportsRequired(){
      const tPrim = $("#core_target_primary")?.value?.trim() || "";
      const tSec  = ($("#core_target_secondary")?.value ?? "").trim() || "Aucun";
      return (tSec !== "Aucun" && tSec !== "") || (tPrim && tPrim !== "LEAD");
    }

    // ---------- DONE Gate + status ----------
    function refreshGates() {
      const btn = $("#btn_mark_done");
      const runbar = $("#runbar");

      // Required: SIG + PATH_COMMIT must not be SKIP
      const sig = groupValue("test_sig");
      const pathCommit = groupValue("test_path_commit");

      const requiredInvalid = (sig === "SKIP" || sig === "") || (pathCommit === "SKIP" || pathCommit === "");

      // Supports: if required AND all support tests are SKIP
      const needSupports = supportsRequired();
      const supportGroups = ["test_mute_supports","test_mute_lead","test_side_only"];
      const supportVals = supportGroups.map(g => groupValue(g)).filter(Boolean);
      const supportAllSkip = needSupports && supportVals.length && supportVals.every(v => v === "SKIP");

      const invalid = requiredInvalid || supportAllSkip;

      if (btn) {
        btn.disabled = invalid;
        btn.title = invalid
          ? "DONE impossible: SIG OFF/ON + PATH_COMMIT requis (et supports si n√©cessaires)."
          : "OK pour passer DONE.";
      }
      const gateText = $("#gateText");
      if (gateText) {
        if (invalid) {
          const why = [];
          if (sig === "SKIP" || sig === "") why.push("SIG_OFF/ON");
          if (pathCommit === "SKIP" || pathCommit === "") why.push("PATH_COMMIT");
          if (supportAllSkip) why.push("SUPPORTS");
          gateText.textContent = "DONE: bloqu√© (" + why.join(", ") + ")";
        } else {
          gateText.textContent = "DONE: OK";
        }
      }
      // update progress bar fail state too
      updateProgress();
    }

    function markDone() {
      const btn = $("#btn_mark_done");
      if (btn.disabled) {
        // feedback
        const runbar = $("#runbar");
        runbar.classList.remove("shake");
        void runbar.offsetWidth;
        runbar.classList.add("shake");
        toast("DONE refus√©: corrige les gates (SIG_OFF/ON + PATH_COMMIT, + supports si requis).");
        // jump to first blocking
        jumpToFirstBlocking();
        return;
      }
      $("#status_done").checked = true;
      $("#status_active").checked = false;
      $("#status_needs_retest").checked = false;
      $("#status_risk").checked = false;
      saveState();
      toast("Status ‚Üí DONE ‚úÖ");
    }

    // ---------- Progress bar ----------
    function updateProgress() {
      const rows = $$("tr[data-kind='test-row']");
      const total = rows.length;
      let filled = 0;
      let anyFail = false;

      rows.forEach(row => {
        const name = row.querySelector('input[type="radio"]')?.name;
        if (!name) return;
        const val = groupValue(name);
        if (val) filled++;
        if (val === "FAIL") anyFail = true;
      });

      const pct = total ? Math.round((filled / total) * 100) : 0;

      const bar = $("#progressBar");
      const inner = $("#progressBar > div");
      if (inner) inner.style.width = pct + "%";
      if (bar) bar.classList.toggle("is-fail", anyFail);

      const txt = $("#progressText");
      if (txt) txt.textContent = `${filled}/${total} tests`;
    }

    // ---------- Scroll spy nav ----------
    function bindScrollSpy() {
      const sections = $$("[data-section]");
      const links = $$("#nav a[data-nav]");
      const map = new Map(links.map(a => [a.getAttribute("data-nav"), a]));

      const obs = new IntersectionObserver((entries) => {
        // pick the most visible entry
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (!visible) return;

        const id = visible.target.id;
        links.forEach(a => a.classList.remove("is-current"));
        const hit = map.get(id);
        if (hit) hit.classList.add("is-current");
      }, { root: null, threshold: [0.25, 0.45, 0.65] });

      sections.forEach(s => obs.observe(s));
    }

    // ---------- Next section (T3) ----------
    const t3Order = ["state","path","target","core","tests","handoff"];
    function nextSection() {
      const y = window.scrollY;
      const current = t3Order.find(id => {
        const el = document.getElementById(id);
        if (!el) return false;
        const rect = el.getBoundingClientRect();
        return rect.top >= 0 && rect.top < window.innerHeight * 0.45;
      }) || t3Order[0];

      const idx = t3Order.indexOf(current);
      const nextId = t3Order[Math.min(idx + 1, t3Order.length - 1)];
      document.getElementById(nextId)?.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    // ---------- Jump to FAIL / blocking ----------
    function flashRow(row){
      if (!row) return;
      row.classList.remove("is-attn");
      void row.offsetWidth;
      row.classList.add("is-attn");
      setTimeout(()=>row.classList.remove("is-attn"), 1800);
    }

    function jumpToFirstFail() {
      const rows = $$("tr[data-kind='test-row']");
      for (const row of rows) {
        const name = row.querySelector('input[type="radio"]')?.name;
        if (!name) continue;
        const val = groupValue(name);
        if (val === "FAIL") {
          $("#tests").scrollIntoView({ behavior:"smooth", block:"start" });
          setTimeout(()=>{
            row.scrollIntoView({ behavior:"smooth", block:"center" });
            flashRow(row);
          }, 180);
          return true;
        }
      }
      return false;
    }

    function jumpToFirstBlocking() {
      const rows = $$("tr[data-kind='test-row']");
      // required blockers first
      const requiredTests = [
        { name:"test_sig", selector:'tr[data-test="sig_ab"]' },
        { name:"test_path_commit", selector:'tr[data-test="path_commit"]' }
      ];
      for (const rt of requiredTests) {
        const val = groupValue(rt.name);
        if (val === "" || val === "SKIP") {
          const row = $(rt.selector);
          $("#tests").scrollIntoView({ behavior:"smooth", block:"start" });
          setTimeout(()=>{
            row.scrollIntoView({ behavior:"smooth", block:"center" });
            flashRow(row);
          }, 180);
          return true;
        }
      }

      // supports blockers
      if (supportsRequired()) {
        const supportRows = $$('tr[data-support="true"]');
        const allSkip = supportRows.length && supportRows.every(r => {
          const name = r.querySelector('input[type="radio"]')?.name;
          const val = name ? groupValue(name) : "";
          return val === "SKIP";
        });
        if (allSkip) {
          $("#tests").scrollIntoView({ behavior:"smooth", block:"start" });
          setTimeout(()=>{
            supportRows[0].scrollIntoView({ behavior:"smooth", block:"center" });
            flashRow(supportRows[0]);
          }, 180);
          return true;
        }
      }

      // else go to first FAIL
      return jumpToFirstFail();
    }

    // ---------- RUN / FAIL modes ----------
    function setRunMode() {
      $$("details.card").forEach(d => d.open = false);
      toast("RUN mode: sections FAIL/TECH repli√©es.");
    }
    function setFailMode() {
      // open the key fail panels (redflags + signature + socle)
      ["redflags","sigfail","soclefail"].forEach(id => {
        const d = document.getElementById(id);
        if (d && d.tagName.toLowerCase()==="details") d.open = true;
      });
      toast("FAIL mode: panneaux diagnostic ouverts.");
    }

    // ---------- Density switch ----------
    function toggleDensity() {
      const cur = document.body.getAttribute("data-density") || "comfy";
      const next = (cur === "comfy") ? "compact" : "comfy";
      document.body.setAttribute("data-density", next);
      saveState();
      toast("Densit√©: " + next);
    }

    // ---------- Command palette ----------
    const backdrop = $("#paletteBackdrop");
    const palInput = $("#paletteInput");
    const palList  = $("#paletteList");

    const commands = [
      { label:"Go CORE",           hint:"core",    run:()=> $("#core").scrollIntoView({behavior:"smooth", block:"start"}) },
      { label:"Go TESTS",          hint:"tests",   run:()=> $("#tests").scrollIntoView({behavior:"smooth", block:"start"}) },
      { label:"Open SYMPT√îMES SIGNATURE", hint:"signature", run:()=> { $("#sigfail").open = true; $("#sigfail").scrollIntoView({behavior:"smooth", block:"start"}); } },
      { label:"Open RED FLAGS",    hint:"redflags",run:()=> { $("#redflags").open = true; $("#redflags").scrollIntoView({behavior:"smooth", block:"start"}); } },
      { label:"Next FAIL / blocker", hint:"fail",  run:()=> jumpToFirstBlocking() },
      { label:"Toggle density (Comfy/Compact)", hint:"density", run:()=> toggleDensity() },
      { label:"Mark DONE (if gates OK)", hint:"done", run:()=> markDone() },
    ];

    function openPalette() {
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden","false");
      palInput.value = "";
      renderCommands("");
      setTimeout(()=> palInput.focus(), 0);
    }
    function closePalette() {
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden","true");
      hideTip();
    }
    function renderCommands(q) {
      const query = q.trim().toLowerCase();
      const items = commands.filter(c =>
        !query || c.label.toLowerCase().includes(query) || c.hint.includes(query)
      );

      palList.innerHTML = items.map((c, idx) => `
        <div class="cmd" data-idx="${idx}">
          <div>${c.label}</div>
          <div class="k">${c.hint}</div>
        </div>
      `).join("");
      // attach click
      $$(".cmd", palList).forEach((el, i) => {
        el.addEventListener("click", () => {
          items[i].run();
          closePalette();
        });
      });
    }

    // ---------- Bindings ----------
    function bindUI() {
      $("#btn_mark_done")?.addEventListener("click", markDone);
      $("#btn_next_section")?.addEventListener("click", nextSection);
      $("#btn_next_fail")?.addEventListener("click", () => jumpToFirstBlocking());
      $("#btn_run_mode")?.addEventListener("click", setRunMode);
      $("#btn_fail_mode")?.addEventListener("click", setFailMode);
      $("#btn_density")?.addEventListener("click", toggleDensity);
      $("#btn_open_palette")?.addEventListener("click", openPalette);
      $("#btn_open_palette_2")?.addEventListener("click", openPalette);

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closePalette();
      });

      palInput.addEventListener("input", () => renderCommands(palInput.value));
      palInput.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closePalette();
        if (e.key === "Enter") {
          const first = $(".cmd", palList);
          if (first) first.click();
        }
      });

      document.addEventListener("keydown", (e) => {
        // Ctrl+K opens palette
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          openPalette();
        }
        // Esc closes palette
        if (e.key === "Escape" && backdrop.style.display === "flex") closePalette();
      });
    }

    // ---------- Boot ----------
    loadState();

    // Make sure defaults are sensible if empty
    if (!$("#core_target_secondary").value) $("#core_target_secondary").value = "Aucun";
    if (!$("#core_target_primary").value) $("#core_target_primary").value = "RETURNS";

    bindAutoSave();
    bindUI();
    bindScrollSpy();

    // initial refresh
    refreshRowState();
    refreshGates();
    updateProgress();

  })();
  </script>
</body>
</html>
'''
out_path = Path("/mnt/data/P13.html")
out_path.write_text(html, encoding="utf-8")
str(out_path)
